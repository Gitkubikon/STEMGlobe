import{hr as z,hs as E,ht as F,hu as $,hv as S,hw as k,hx as G}from"./index-DqwbqM4t.js";class K{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(t){return this._resourceMap.get(t)??null}async fetchResource(t,u){const n=this._resourceMap.get(t);if(n)return{width:n.width,height:n.height};let o=this._inFlightResourceMap.get(t);return o?o.then(s=>({width:s.width,height:s.height})):(o=z(t,u),this._inFlightResourceMap.set(t,o),o.then(s=>(this._inFlightResourceMap.delete(t),this._resourceMap.set(t,s),{width:s.width,height:s.height}),()=>({width:0,height:0})))}deleteResource(t){this._inFlightResourceMap.delete(t),this._resourceMap.delete(t)}loadFont(t){return E(t)}}const V=96/72;class A{constructor(t){this._spatialReference=t,this._imageDataCanvas=null,this._cimResourceManager=new K}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,u,n,o,s,h,c,l,_){if(!t)return null;const{data:d}=t;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:b}=d;h||(h=F(b));const a=await $.resolveSymbolOverrides(d,u,this._spatialReference,s,h,c,l),y=this._cimResourceManager,M=[];S.fetchResources(a,y,M),S.fetchFonts(a,y,M),M.length>0&&await Promise.all(M);const{width:i,height:r}=n,f=P(h,i,r,o),e=S.getEnvelope(a,f,y);if(!e)return null;let g=1,x=0,C=0;switch(b.type){case"CIMPointSymbol":case"CIMTextSymbol":{let w=1;e.width>i&&(w=i/e.width);let p=1;e.height>r&&(p=r/e.height),o==="preview"&&(e.width<i&&(w=i/e.width),e.height<r&&(p=r/e.height)),g=Math.min(w,p),x=e.x+e.width/2,C=e.y+e.height/2}break;case"CIMLineSymbol":{(_||e.height>r)&&(g=r/e.height),C=e.y+e.height/2;const w=e.x*g+i/2,p=(e.x+e.width)*g+i/2,{paths:R}=f;R[0][0][0]-=w/g,R[0][2][0]-=(p-i)/g}break;case"CIMPolygonSymbol":{x=e.x+e.width/2,C=e.y+e.height/2;const w=e.x*g+i/2,p=(e.x+e.width)*g+i/2,R=e.y*g+r/2,I=(e.y+e.height)*g+r/2,{rings:m}=f;w<0&&(m[0][0][0]-=w,m[0][3][0]-=w,m[0][4][0]-=w),R<0&&(m[0][0][1]+=R,m[0][1][1]+=R,m[0][4][1]+=R),p>i&&(m[0][1][0]-=p-i,m[0][2][0]-=p-i),I>r&&(m[0][2][1]+=I-r,m[0][3][1]+=I-r)}}const D={type:"cim",data:{type:"CIMSymbolReference",symbol:a}};return this.rasterize(D,i,r,x,C,g,h,1,f)}rasterize(t,u,n,o,s,h,c,l=0,_=null){const{data:d}=t;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:b}=d,a=this._canvas,y=(window.devicePixelRatio||1)*V;a.width=u*y,a.height=n*y,c||(c=F(b)),_||(_=P(c,u,n,"legend")),a.width+=2*l,a.height+=2*l;const M=a.getContext("2d",{willReadFrequently:!0}),i=G.createIdentity();return i.translate(-o,-s),i.scale(h*y,-h*y),i.translate(u*y/2+l,n*y/2+l),M.clearRect(0,0,a.width,a.height),new k(M,this._cimResourceManager,i,!0).drawSymbol(b,_),M.getImageData(0,0,a.width,a.height)}}function P(v,t,u,n){const s=-t/2+1,h=t/2-1,c=u/2-1,l=-u/2+1;switch(v){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[h,0]]]};default:return n==="legend"?{rings:[[[s,c],[h,0],[h,l],[s,l],[s,c]]]}:{rings:[[[s,c],[h,c],[h,l],[s,l],[s,c]]]}}}export{A as CIMSymbolRasterizer};
